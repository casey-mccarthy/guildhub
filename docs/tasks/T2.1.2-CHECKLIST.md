# Task T2.1.2: Configure OmniAuth Discord - Checklist

**Epic:** 2 - Discord OAuth Authentication
**Story Points:** 2
**Time Estimate:** 2 hours
**Status:** Completed

## Overview

Configure OmniAuth middleware for Discord OAuth authentication. This sets up the Rails application to handle "Login with Discord" requests.

**Prerequisites:** T2.1.1 completed (Discord app created, credentials stored)

---

## Acceptance Criteria

- [x] OmniAuth configured in initializers
- [x] Discord provider configured with credentials
- [x] OAuth scopes set: `identify`, `email`
- [x] Callback URL configured: `/auth/discord/callback`
- [x] Routes configured for OAuth callbacks
- [x] OmniAuth tests pass

---

## What Was Implemented

### 1. OmniAuth Initializer

**File:** `config/initializers/omniauth.rb`

**Features:**
- Discord provider configuration
- Credentials loaded from Rails encrypted credentials
- OAuth scopes: `identify email`
- Callback path: `/auth/discord/callback`
- Failure handler with error logging
- Production HTTPS enforcement
- Development logging enabled

### 2. Routes Configuration

**File:** `config/routes.rb`

**Routes Added:**
```ruby
get "/auth/:provider/callback" # OAuth success callback
get "/auth/failure"             # OAuth failure handler
```

### 3. Tests

**File:** `spec/config/omniauth_spec.rb`

**Test Coverage:**
- Middleware setup verification
- OmniAuth settings validation
- Discord provider configuration
- Callback routes existence
- Production HTTPS configuration

---

## Configuration Details

### OAuth Scopes

```ruby
scope: "identify email"
```

**Scopes Explained:**
- `identify` - Read username, discriminator, ID, avatar
- `email` - Read user's email address

### Callback URL

```ruby
callback_path: "/auth/discord/callback"
```

**Full Development URL:** `http://localhost:3000/auth/discord/callback`

**Production URL:** `https://yourdomain.com/auth/discord/callback`

### Credentials Structure

```yaml
discord:
  client_id: "YOUR_CLIENT_ID"
  client_secret: "YOUR_CLIENT_SECRET"
```

Loaded via:
```ruby
Rails.application.credentials.dig(:discord, :client_id)
Rails.application.credentials.dig(:discord, :client_secret)
```

---

## Testing

### Run OmniAuth Tests

```bash
# Run OmniAuth configuration tests
bundle exec rspec spec/config/omniauth_spec.rb

# Run all configuration tests
bundle exec rspec spec/config/
```

### Verify Routes

```bash
# Check OAuth routes exist
bin/rails routes | grep auth

# Expected output:
# auth_callback GET /auth/:provider/callback auth/callbacks#create
# auth_failure  GET /auth/failure           auth/callbacks#failure
```

### Test in Console

```bash
bin/rails console
```

```ruby
# Check OmniAuth middleware is loaded
Rails.application.config.middleware.include?("OmniAuth::Builder")
# => true

# Verify allowed request methods
OmniAuth.config.allowed_request_methods
# => [:get, :post]

# Check credentials are accessible
Rails.application.credentials.dig(:discord, :client_id)
# => "YOUR_CLIENT_ID"

exit
```

---

## OAuth Flow (How It Works)

1. **User clicks "Login with Discord"**
   - Links to: `/auth/discord`
   - OmniAuth redirects to Discord

2. **User authorizes on Discord**
   - Discord shows authorization screen
   - User approves scopes: identify, email

3. **Discord redirects back**
   - Callback URL: `/auth/discord/callback`
   - Includes authorization code

4. **OmniAuth exchanges code for token**
   - Gets access token from Discord
   - Fetches user info (username, email, avatar)

5. **Callback controller handles response**
   - Creates/updates User record
   - Sets session
   - Redirects to dashboard

---

## Security Features

### CSRF Protection

```ruby
gem "omniauth-rails_csrf_protection"
```

Prevents CSRF attacks on OAuth flow.

### HTTPS in Production

```ruby
if Rails.env.production?
  OmniAuth.config.full_host = ENV["OAUTH_FULL_HOST"] || "https://guildhub.com"
end
```

Ensures OAuth callbacks use HTTPS in production.

### Error Handling

```ruby
OmniAuth.config.on_failure = proc { |env|
  # Log error
  # Redirect to login with error message
}
```

Gracefully handles OAuth failures.

---

## Troubleshooting

### "OmniAuth::Builder not found" Error

**Solution:**
```bash
# Ensure gems are installed
bundle install

# Restart Rails server
# Ctrl+C to stop, then:
bin/dev
```

### Routes not recognized

**Solution:**
```bash
# Clear routes cache
bin/rails restart

# Verify routes
bin/rails routes | grep auth
```

### Credentials not loading

**Solution:**
```bash
# Verify credentials are set
bin/rails credentials:show

# Should show discord section
# If not, edit and add:
bin/rails credentials:edit
```

---

## Next Steps

After completing T2.1.2:

- ✅ **T2.1.1:** Create Discord Application
- ✅ **T2.1.2:** Configure OmniAuth Discord ← You are here
- ⏭️ **T2.1.3:** Create Users migration and model
- ⏭️ **T2.1.4:** Implement OmniAuth callback controller
- ⏭️ **T2.1.5:** Add Discord login button

---

## Files Modified

- `config/initializers/omniauth.rb` (created)
- `config/routes.rb` (updated)
- `spec/config/omniauth_spec.rb` (created)
- `docs/tasks/T2.1.2-CHECKLIST.md` (created)

---

## References

- **OmniAuth Documentation:** https://github.com/omniauth/omniauth
- **OmniAuth Discord:** https://github.com/wingrunr21/omniauth-discord
- **Discord OAuth Scopes:** https://discord.com/developers/docs/topics/oauth2#shared-resources-oauth2-scopes
- **Rails Middleware:** https://guides.rubyonrails.org/rails_on_rack.html

---

*Last Updated: October 27, 2025*
