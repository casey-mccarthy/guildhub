# Task T2.1.3: Create Users Migration and Model - Checklist

**Epic:** 2 - Discord OAuth Authentication
**Story Points:** 2
**Time Estimate:** 2 hours
**Status:** Completed

## Overview

Create the Users table and model to store Discord OAuth user data and admin credentials.

**Prerequisites:** T2.1.2 completed (OmniAuth configured)

---

## Acceptance Criteria

- [x] Users migration created
- [x] User model created with validations
- [x] Indexes: discord_id (unique), email
- [x] NOT NULL constraint on discord_id
- [x] Default value for admin (false)
- [x] Comprehensive tests written
- [x] Factory created for testing
- [ ] Migration run successfully

---

## What Was Implemented

### 1. Database Migration

**File:** `db/migrate/XXXXXX_create_users.rb`

**Schema:**
```ruby
create_table :users do |t|
  t.string :discord_id, null: false        # Discord user ID (snowflake)
  t.string :discord_username               # Discord username (with discriminator)
  t.string :discord_avatar_url             # CDN URL to avatar
  t.string :email                          # Discord-provided email
  t.string :encrypted_password             # For Devise admin auth (Phase 2.3)
  t.boolean :admin, default: false, null: false

  t.timestamps
end

add_index :users, :discord_id, unique: true
add_index :users, :email
```

**Database Constraints:**
- `discord_id` - NOT NULL, UNIQUE
- `admin` - NOT NULL, DEFAULT false
- Unique index on `discord_id`
- Index on `email` for faster lookups

### 2. User Model

**File:** `app/models/user.rb`

**Validations:**
- `discord_id` - presence, uniqueness
- `discord_username` - presence
- `email` - format (allows blank)

**Scopes:**
- `.admins` - Returns admin users
- `.members` - Returns non-admin users
- `.with_discord` - Returns users with Discord ID

**Class Methods:**
- `.from_omniauth(auth_hash)` - Create/update user from OAuth response
- `.format_discord_username(auth_hash)` - Format username with discriminator

**Instance Methods:**
- `#discord_avatar(size: 128)` - Get avatar URL with specific size
- `#admin?` - Check if user is admin
- `#member?` - Check if user is member
- `#display_name` - User's display name (username > email > ID)

**Callbacks:**
- `before_validation :normalize_email` - Downcase and strip email

### 3. Tests

**File:** `spec/models/user_spec.rb`

**Test Coverage:**
- Validations (presence, uniqueness, format)
- Database constraints (NOT NULL, unique index)
- Scopes (admins, members, with_discord)
- Class methods (from_omniauth, format_discord_username)
- Instance methods (discord_avatar, admin?, member?, display_name)
- Callbacks (normalize_email)
- Defaults (admin = false)

**Total:** 30+ test cases

### 4. Factory

**File:** `spec/factories/users.rb`

**Features:**
- Realistic Discord IDs (snowflakes)
- Random usernames with discriminators
- CDN-formatted avatar URLs
- Traits: `:admin`, `:member`, `:without_email`, `:without_avatar`
- Named factories: `:admin_user`, `:member_user`

---

## Running the Migration

### Local Development

```bash
# Run migration
bin/rails db:migrate

# Check status
bin/rails db:migrate:status

# Rollback if needed
bin/rails db:rollback
```

### Docker

```bash
# Run migration in Docker
docker-compose exec web bin/rails db:migrate

# Or run with docker-compose up
docker-compose up
docker-compose exec web bin/rails db:migrate
```

### Verify Migration

```bash
bin/rails console
```

```ruby
# Check table exists
ActiveRecord::Base.connection.table_exists?(:users)
# => true

# Check columns
User.column_names
# => ["id", "discord_id", "discord_username", "discord_avatar_url",
#     "email", "encrypted_password", "admin", "created_at", "updated_at"]

# Check indexes
ActiveRecord::Base.connection.indexes(:users)
# Should show unique index on discord_id and index on email

exit
```

---

## Testing

### Run User Model Tests

```bash
# Run all user tests
bundle exec rspec spec/models/user_spec.rb

# Run with documentation format
bundle exec rspec spec/models/user_spec.rb --format documentation

# Run specific test
bundle exec rspec spec/models/user_spec.rb:10
```

### Test Factory

```bash
bin/rails console
```

```ruby
# Create test user
user = FactoryBot.create(:user)
user.attributes

# Create admin user
admin = FactoryBot.create(:admin_user)
admin.admin?
# => true

# Create user without email
user = FactoryBot.create(:user, :without_email)
user.email
# => nil

exit
```

---

## User Model Usage

### Creating Users from OAuth

```ruby
# From OmniAuth callback (T2.1.4)
auth_hash = request.env['omniauth.auth']
user = User.from_omniauth(auth_hash)

# This will:
# 1. Find existing user by discord_id
# 2. Or create new user
# 3. Update username, email, avatar
# 4. Save and return user
```

### Manual User Creation

```ruby
# Create Discord user
user = User.create!(
  discord_id: "123456789012345678",
  discord_username: "player#1234",
  discord_avatar_url: "https://cdn.discordapp.com/avatars/123/abc.png",
  email: "player@example.com"
)

# Create admin user (for Devise in T2.3)
admin = User.create!(
  discord_id: "987654321098765432",
  discord_username: "admin#9999",
  email: "admin@guildhub.com",
  admin: true,
  encrypted_password: BCrypt::Password.create("secure_password")
)
```

### Querying Users

```ruby
# Find by Discord ID
user = User.find_by(discord_id: "123456789012345678")

# Get all admins
admins = User.admins

# Get all members
members = User.members

# Check user role
user.admin?  # => false
user.member? # => true

# Get display name
user.display_name  # => "player#1234"

# Get avatar with specific size
user.discord_avatar(size: 256)
```

---

## Discord Username Format

Discord is transitioning username formats:

**Old Format (with discriminator):**
```
username#1234
```

**New Format (no discriminator):**
```
username
```

The `format_discord_username` method handles both:
- If `discriminator` exists and != "0" → "username#1234"
- If `discriminator` == "0" or missing → "username"

---

## Schema Details

### Discord ID (Snowflake)

Discord uses snowflake IDs (18-19 digit numbers):
```
123456789012345678
```

Stored as `string` (not integer) to avoid overflow issues.

### Avatar URLs

Discord CDN format:
```
https://cdn.discordapp.com/avatars/{user_id}/{avatar_hash}.png?size=128
```

Sizes: 16, 32, 64, 128, 256, 512, 1024, 2048

### Admin Flag

- `false` - Regular guild member (Discord OAuth only)
- `true` - Guild officer/admin (can use admin panel with Devise)

---

## Security Considerations

### Password Hashing

```ruby
# Only for admin users (Devise in T2.3)
BCrypt::Password.create("password")
```

### Email Normalization

```ruby
# Automatically downcased and stripped
User.create(email: "  TEST@EXAMPLE.COM  ")
# Stored as: "test@example.com"
```

### Discord ID Validation

```ruby
# Must be present and unique
validates :discord_id, presence: true, uniqueness: true
```

---

## Troubleshooting

### "PG::UndefinedTable: relation 'users' does not exist"

**Solution:**
```bash
# Run migration
bin/rails db:migrate

# Or reset database
bin/rails db:reset
```

### "ActiveRecord::NotNullViolation: discord_id"

**Solution:**
```ruby
# discord_id is required
User.create!(
  discord_id: "123456789012345678",  # Required!
  discord_username: "username"
)
```

### Factory not found

**Solution:**
```bash
# Ensure FactoryBot is loaded in test environment
bundle install

# Check spec/support directory
ls spec/support/

# Verify factories are defined
bin/rails console --environment=test
FactoryBot.factories.to_a
```

---

## Next Steps

After completing T2.1.3:

- ✅ **T2.1.1:** Create Discord Application
- ✅ **T2.1.2:** Configure OmniAuth Discord
- ✅ **T2.1.3:** Create Users migration and model ← You are here
- ⏭️ **T2.1.4:** Implement OmniAuth callback controller
- ⏭️ **T2.1.5:** Add Discord login button

---

## Files Created/Modified

- `db/migrate/XXXXXX_create_users.rb` (created)
- `app/models/user.rb` (created)
- `spec/models/user_spec.rb` (created)
- `spec/factories/users.rb` (created)
- `docs/tasks/T2.1.3-CHECKLIST.md` (created)

---

## References

- **Discord Snowflakes:** https://discord.com/developers/docs/reference#snowflakes
- **Discord OAuth:** https://discord.com/developers/docs/topics/oauth2
- **Rails Migrations:** https://guides.rubyonrails.org/active_record_migrations.html
- **ActiveRecord Validations:** https://guides.rubyonrails.org/active_record_validations.html
- **FactoryBot:** https://github.com/thoughtbot/factory_bot/blob/master/GETTING_STARTED.md

---

*Last Updated: October 27, 2025*
