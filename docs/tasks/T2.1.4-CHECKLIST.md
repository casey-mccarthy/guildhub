# Task T2.1.4: Implement OmniAuth Callback Controller - Checklist

**Epic:** 2 - Discord OAuth Authentication
**Story Points:** 2
**Time Estimate:** 3 hours
**Status:** Completed

## Overview

Implement the controller that handles OAuth callbacks from Discord, creates/updates users, and manages sessions.

**Prerequisites:** T2.1.3 completed (Users model created)

---

## Acceptance Criteria

- [x] Auth::CallbacksController created
- [x] OAuth callback handler implemented
- [x] User creation/update from auth hash
- [x] Session management (login/logout)
- [x] Error handling and logging
- [x] ApplicationController authentication helpers
- [x] Comprehensive tests written

---

## What Was Implemented

### 1. Auth::CallbacksController

**File:** `app/controllers/auth/callbacks_controller.rb`

**Actions:**
- `create` - Handle successful OAuth callback
- `failure` - Handle OAuth failure

**Features:**
- Creates or updates user from Discord OAuth data
- Sets user session (`session[:user_id]`)
- Redirects to stored location or root
- Comprehensive error handling
- Detailed logging

**Flow:**
1. Receive OAuth callback from Discord
2. Extract auth hash from `request.env['omniauth.auth']`
3. Call `User.from_omniauth(auth_hash)` to create/update user
4. Set session: `session[:user_id] = user.id`
5. Redirect to `after_sign_in_path`

### 2. SessionsController

**File:** `app/controllers/sessions_controller.rb`

**Actions:**
- `destroy` - Logout user and clear session

**Features:**
- Clears user session with `reset_session`
- Logs logout events
- Shows success notice

### 3. ApplicationController Updates

**File:** `app/controllers/application_controller.rb`

**Helper Methods:**
- `current_user` - Get currently signed-in user
- `user_signed_in?` - Check if user is signed in
- `authenticate_user!` - Require authentication (before_action)
- `authenticate_admin!` - Require admin role

**Features:**
- Memoizes current_user for performance
- Stores return path for post-login redirect
- Available in views via `helper_method`

### 4. Routes Updates

**File:** `config/routes.rb`

**Routes Added:**
```ruby
get  "/auth/:provider/callback" => "auth/callbacks#create"
get  "/auth/failure"             => "auth/callbacks#failure"
delete "/logout"                 => "sessions#destroy"
```

### 5. Tests

**Files:**
- `spec/requests/auth/callbacks_spec.rb` - OAuth callback tests
- `spec/requests/sessions_spec.rb` - Logout tests
- `spec/controllers/application_controller_spec.rb` - Auth helper tests

**Test Coverage:**
- Creating new user from OAuth
- Updating existing user
- Setting user session
- Redirect after sign in
- Return path handling
- Error handling (missing auth hash, user creation failure, exceptions)
- OAuth failure handling
- Logout functionality
- Authentication helpers (current_user, user_signed_in?, authenticate_user!, authenticate_admin!)

**Total:** 40+ test cases

---

## OAuth Callback Flow

### Successful Authentication

```
1. User clicks "Login with Discord"
   → Redirects to: /auth/discord

2. OmniAuth middleware intercepts
   → Redirects to Discord authorization page

3. User approves on Discord
   → Discord redirects back to: /auth/discord/callback?code=XXXXX

4. OmniAuth exchanges code for access token
   → Fetches user info from Discord API
   → Stores in request.env['omniauth.auth']

5. Auth::CallbacksController#create handles callback
   → Extract auth_hash
   → Call User.from_omniauth(auth_hash)
   → Set session[:user_id]
   → Redirect to root (or stored return path)

6. User is now logged in
   → current_user returns User object
   → user_signed_in? returns true
```

### Failed Authentication

```
1. OAuth fails (user denies, network error, etc.)
   → Discord redirects to: /auth/failure?message=access_denied

2. Auth::CallbacksController#failure handles error
   → Logs error details
   → Redirects to root with error message

3. User sees error alert
   → "Discord authentication failed: Access denied"
```

---

## Session Management

### Login (Automatic via OAuth)

```ruby
# Set session in Auth::CallbacksController#create
session[:user_id] = @user.id
```

### Check if Logged In

```ruby
# In controller
if user_signed_in?
  # User is logged in
end

# In view
<% if user_signed_in? %>
  Welcome, <%= current_user.display_name %>!
<% end %>
```

### Get Current User

```ruby
# In controller
current_user.admin?
current_user.display_name

# In view
<%= current_user.discord_avatar(size: 64) %>
```

### Logout

```ruby
# Link in view
<%= link_to "Logout", logout_path, method: :delete %>

# Or button with Turbo
<%= button_to "Logout", logout_path, method: :delete %>
```

### Require Authentication

```ruby
# In controller
class CharactersController < ApplicationController
  before_action :authenticate_user!

  def index
    # User must be logged in to access
  end
end
```

### Require Admin

```ruby
class AdminController < ApplicationController
  before_action :authenticate_admin!

  def dashboard
    # User must be admin to access
  end
end
```

---

## Testing

### Run OAuth Tests

```bash
# Run all auth tests
bundle exec rspec spec/requests/auth/
bundle exec rspec spec/requests/sessions_spec.rb
bundle exec rspec spec/controllers/application_controller_spec.rb

# Run specific test
bundle exec rspec spec/requests/auth/callbacks_spec.rb:10

# Run with documentation format
bundle exec rspec spec/requests/auth/ --format documentation
```

### Test in Console

```bash
bin/rails console
```

```ruby
# Simulate OAuth callback
auth_hash = {
  "uid" => "123456789012345678",
  "info" => {
    "name" => "testuser",
    "email" => "test@example.com",
    "image" => "https://cdn.discordapp.com/avatars/123/abc.png"
  },
  "extra" => {
    "raw_info" => {
      "discriminator" => "1234"
    }
  }
}

user = User.from_omniauth(auth_hash)
# => #<User id: 1, discord_id: "123456789012345678", ...>

# Check session helpers
# (Note: session not available in console, test via request specs)

exit
```

---

## Error Handling

### Missing Auth Hash

```ruby
# If request.env['omniauth.auth'] is blank
redirect_to root_path, alert: "Authentication failed: No data received from Discord."
```

### User Creation Failure

```ruby
# If User.from_omniauth fails validation
redirect_to root_path, alert: "Failed to create account. Please try again."
```

### Unexpected Exception

```ruby
# StandardError rescue block
Rails.logger.error "OAuth callback error: #{e.class} - #{e.message}"
redirect_to root_path, alert: "An error occurred during sign in. Please try again."
```

### OAuth Failure

```ruby
# Discord denies authorization, network error, etc.
redirect_to root_path, alert: "Discord authentication failed: Access denied"
```

---

## Security Considerations

### CSRF Protection

```ruby
# Skip CSRF for OAuth callbacks (handled by omniauth-rails_csrf_protection gem)
skip_before_action :verify_authenticity_token, only: [:create, :failure]
```

### Session Fixation Prevention

```ruby
# reset_session clears all session data
# Prevents session fixation attacks
reset_session
```

### Return Path Validation

```ruby
# Only store non-root paths as return_to
session[:return_to] = request.fullpath unless request.fullpath == root_path
```

### Admin Authorization

```ruby
# Always check admin status before granting access
return if current_user&.admin?
# &. safe navigation prevents nil errors
```

---

## Logging

### Successful Login

```ruby
Rails.logger.info "User authenticated via Discord: username#1234 (ID: 1)"
```

### Failed Login

```ruby
Rails.logger.error "Failed to create user from Discord OAuth: Validation failed: Discord id has already been taken"
```

### OAuth Callback Error

```ruby
Rails.logger.error "OAuth callback error: StandardError - Test error"
```

### OAuth Failure

```ruby
Rails.logger.error "OAuth failure: access_denied - User denied authorization"
```

### Logout

```ruby
Rails.logger.info "User logged out: username#1234 (ID: 1)"
```

---

## Return Path Feature

When users try to access protected pages while logged out:

```ruby
# User visits /characters (requires authentication)
# authenticate_user! runs:
session[:return_to] = "/characters"
redirect_to root_path, alert: "Please sign in to continue."

# User logs in via Discord
# Auth::CallbacksController#create redirects:
stored_location = session.delete(:return_to)  # => "/characters"
redirect_to stored_location  # User goes to /characters
```

---

## Integration with Other Controllers

### Public Controller (No Auth Required)

```ruby
class HomeController < ApplicationController
  def index
    # Anyone can access
    # current_user will be nil if not signed in
  end
end
```

### Protected Controller (Auth Required)

```ruby
class CharactersController < ApplicationController
  before_action :authenticate_user!

  def index
    # Only authenticated users
    @characters = current_user.characters
  end
end
```

### Admin Controller (Admin Required)

```ruby
class Admin::GuildsController < ApplicationController
  before_action :authenticate_admin!

  def index
    # Only admins
    @guilds = Guild.all
  end
end
```

---

## Troubleshooting

### "OmniAuth auth hash is missing"

**Solution:**
```bash
# Ensure OmniAuth is configured properly
# Check config/initializers/omniauth.rb

# Verify Discord credentials
bin/rails credentials:show

# Check OmniAuth test mode
OmniAuth.config.test_mode = false  # In production/development
```

### "User creation failed" even with valid data

**Solution:**
```bash
# Check User model validations
bin/rails console
> user = User.new(discord_id: "123", discord_username: "test")
> user.valid?
> user.errors.full_messages

# Ensure database migration ran
bin/rails db:migrate:status
```

### Session not persisting

**Solution:**
```ruby
# Ensure session_store is configured
# config/initializers/session_store.rb should exist

# Check if cookies are enabled in browser

# Verify session[:user_id] is set
Rails.logger.info "Session user_id: #{session[:user_id]}"
```

### "Redirect loop" after login

**Solution:**
```ruby
# Check after_sign_in_path logic
# Ensure it doesn't redirect to a protected page that requires auth

# Verify authenticate_user! doesn't run on root path
# ApplicationController should NOT have:
# before_action :authenticate_user!  # <- Don't do this globally
```

---

## Next Steps

After completing T2.1.4:

- ✅ **T2.1.1:** Create Discord Application
- ✅ **T2.1.2:** Configure OmniAuth Discord
- ✅ **T2.1.3:** Create Users migration and model
- ✅ **T2.1.4:** Implement OmniAuth callback controller ← You are here
- ⏭️ **T2.1.5:** Add Discord login button

---

## Files Created/Modified

- `app/controllers/auth/callbacks_controller.rb` (created)
- `app/controllers/sessions_controller.rb` (created)
- `app/controllers/application_controller.rb` (modified)
- `config/routes.rb` (modified)
- `spec/requests/auth/callbacks_spec.rb` (created)
- `spec/requests/sessions_spec.rb` (created)
- `spec/controllers/application_controller_spec.rb` (created)
- `docs/tasks/T2.1.4-CHECKLIST.md` (created)

---

## References

- **OmniAuth Documentation:** https://github.com/omniauth/omniauth
- **Rails Sessions:** https://guides.rubyonrails.org/action_controller_overview.html#session
- **Rails Authentication:** https://guides.rubyonrails.org/security.html#user-management
- **Discord OAuth:** https://discord.com/developers/docs/topics/oauth2

---

*Last Updated: October 27, 2025*
